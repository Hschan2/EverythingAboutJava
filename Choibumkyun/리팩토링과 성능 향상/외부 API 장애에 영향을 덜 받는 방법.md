# 외부 API 장애에 영향을 덜 받는 세 가지 방법

## 이전
이전 내용들에서 외부 연동과 외부 서비스를 가져오는 과정에서 응답 시간이 늘어갈수록 성능이 저하된다는 내용을 알 수 있었다. 이러한 장애에 영향을 덜 받는 방법으로 세 가지를 알아가도록 한다.   

## 타임아웃
오래 대기하는 것보다 빠르게 에러를 발생시키는 것이 나을 때가 있다. 동시에 대기하는 외부 연동 개수가 많아질수록 서비스는 조금씩 먹통이 되고 느려진다.   

외부 API 호출 시 두 개의 타임아웃이 설정이 된다. 첫 번째는 <b>연결 시간 타임 아웃</b>으로 보통 1초에서 5초 이내로 설정을 한다. 그리고 두 번째는 <b>응답 시간 타임 아웃</b>으로 보통 1초에서 3초 사이가 적당하다. 그러나 외부 서비스 특징에 따라 길게 주기도 한다. 예를 들어서 결제 승인은 약 30초 정도로 설정한다.   

그리고 HTTP 커넥션 풀 사용 시 추가 타임 아웃 설정은 풀에서 커넥션을 구할 때 대기하는 최대 시간으로 한다. 보통 1초에서 5초 이내로 설정한다.   

```
                     풀
    커넥션 요청 ->    -------
    커넥션 요청 ->    |유휴  |
    커넥션 요청 ->    |사용중|
    커넥션 요청 ->    -------
```

### 외부 연동 서비스가 많을 때
특정 서비스 장애가 발생하면 전체에 영향을 준다.   

예를 들어서 A, B, C 연동에 대해 커넥션 풀을 공유할 때, <b>A 서비스</b>의 장애로 응답 시간 지연이 발생하면 풀에 남은 유휴 커넥션이 줄어들고 풀에서 커넥션을 구하는 대기 시간이 증가한다. 그리고 <b>B</b>, <b>C 서비스</b>에 대한 연동도 같이 대기하게 된다.   

```
내 서비스               |
A 연동코드 ->              -> A 서비스
B 연동코드 ---> 커넥션풀 ----> B 서비스
C 연동코드 - >             -> C 서비스
```

이럴 경우, 격벽이라는 <b>벌크헤드</b>를 활용하여 해결할 수 있다.   

## 벌크헤드
기능과 서비스, 클라이언트 마다 자원 사용을 분리한다. 한 기능과 서비스 장애가 다른 기능, 서비스에 주는 영향을 최소화한다.   

예를 들어서, 외부 서비스마다 별도의 커넥션풀을 사용한다. 트래픽 규모에 따라 서로 다른 커넥션 풀을 설정한다. A 서비스와 연동이 느려져도 B, C 서비스 연동은 영향을 덜 받는다.   

```
내 서비스               |
A 연동코드 ---> 커넥션 풀 ---> A 서비스
B 연동코드 ---> 커넥션 풀 ---> B 서비스
C 연동코드 ---> 커넥션 풀 ---> C 서비스
```

### 외부 시스템 장애 지속 시
계속되는 타임아웃과 50x 응답에 따른 서비스 에러가 발생할 경우, 외부 서비스가 비정상임에도 계속해서 요청을 보낸다. 결과적으로 응답 시간이 느려지고 처리량이 감소한다.   

```
내 서비스 ---x---> 외부 서비스
```

## 서킷 브레이커
오류가 계속 지속 시 일정 시간동안 기능 실행을 차단한다. 기능을 실행하지 않고 바로 에러를 응답한다.   

* <b>빠른 실패(Fail Fast)</b> - 외부 서비스 장애에 따른 응답 시간 증가 감소 완화   

```
연동 코드 --- 서킷 브레이커 ---> 외부 서비스(정상)
연동 코드 --- 서킷 브레이커 --X--> 외부 서비스(오류)
연동 코드 --X--> 서킷 브레이커 오픈  |  외부 서비스(오류)
```

외부 서비스에서 문제가 발생해도 나의 서비스는 일정 수준의 품질을 유지할 수 있다. 고객에게 어느 정도 에러를 줄 수 있지만 응답을 보낼 수 있다.   

### 서킷 브레이커 동작 방식
먼저 서킷 브레이커가 닫혀 있다. 이는 들어오는 모든 요청을 받아들인다는 것이다. HTTP 외부 호출을 모두 받아들인다는 것이다. 임계치를 초과한 실패가 발생할 경우, 서킷 브레이커가 열린다. 이럴 경우, 바로 에러를 응답한다. 다음 API 호출을 하지 않는다는 것이다. 그리고 일정 시간동안 서킷 브레이커를 유지하고 지정한 시간 후에 반 정도 연다. (Half Open) 그리고 이전에 호출하지 않는 다음 API 호출을 시도한다. 만약에 임계치를 초과한 실패가 발생할 경우, 다시 서킷 브레이커를 모두 연다. 혹은 임계치 이하로 실패가 발생할 경우, 서킷 브레이커를 닫는다.   

쉽게 정리하자면   
1. 먼저 서킷 브레이커는 닫혀 있음 (HTTP 외부 호출 등 모든 요청을 받음)   
2. 임계치 초과한 실패 발생하면 서킷 브레이커 열림 (바로 에러 응답, 다음 API 호출하지 않음)   
3. 일정 시간을 유지한 후 지정한 시간 후 서킷 브레이커 반 정도 열림 (Half Open, 이전에 호출하지 않은 다음 API 호출 시도)   
4. 그럼에도 불구하고 임계치를 초과한 실패 발생하면 다시 서킷 브레이커 모두 열림   
5. 혹은 임계치 이하로 실패가 발생하면 서킷 브레이커 닫음   

```
닫힘 ------(임계치를 초과한 실패 발생)------> 열림
  ^                                          | ^
  |                                          | |
  |                                          | | (임계치를 초과한 실패 발생)
  |                        (지정한 시간 지남) | |
  |                                          | |
  |                                          v |
  --------------------------------------  반 열림
  (임계치 이하로 실패 발생)
```

## 정리
연동 시스템에서 장애가 발생할 경우 영향을 줄이는 세 가지 방법은 다음과 같다.   

* 타임 아웃
* 벌크헤드
* 서킷 브레이커

[외부 장애 영향 덜 받는 세 가지 방법](https://www.youtube.com/watch?v=nuRO0ZBFdKk)