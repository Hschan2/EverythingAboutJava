# 초식: 웹 서비스 서버 성능 올리기 (처리량, 응답 시간) - 초보자용

## 서버 성능 기본 지표 2개 - 응답 시간, 처리량
```
                        TPS(Transaction Per Second)
                        초당 몇 개 클라이언트 요청 처리
클라이언트(브라우저)                서버                        데이터 베이스
            <-대기시간(Latency Time)-><-처리시간(Processing Time)->
            <---------------응답시간(Response Time)-------------->
```

## TPS를 높이려면
가장 쉬운 방법은 <b>서버 늘리기</b>이다. 단순하게 서버가 1대일 경우 10 TPS라면, 2대면 20 TPS이다.   

비슷한 방법으로 <b>쓰레드 풀 + 데이터 베이스 커넥션 풀 늘리기</b>이다. 이는 도잇에 처리할 수 있는 개수를 말하는데 예로 들어서 쓰레드 풀이 5이고 처리 시간이 1초이면 TPS는 5이고 쓰레드 풀이 10이고 처리 시간이 1초이면 TPS는 10이 된다.   

## 서버 늘리기와 쓰레드 풀 늘리기의 한계
데이터 베이스에 대한 부하가 임계치를 넘어가면 먹통 증상이 발생한다. 데이터 베이스 쿼리 시간이 증가하면 처리 시간이 길어지고 TPS는 떨어지게 된다.   

그래서 TPS를 높이려면 기본적으로 처리 시간을 줄여야 한다. 예를 들어 처리 시간이 1초이고 쓰레드풀이 10일 경우는 10 TPS이 될 것이고 처리 시간이 0.5초이고 쓰레드풀이 10일 경우는 20 TPS가 될 것이다. 이는 위의 긱본 지표 2개에서 보이는 것과 같다.   

## 처리 시간을 줄이려면
처리 시간에서 비중이 높은 대상을 찾아서 줄여야 한다. 대부분 비중이 높은 대상은 <b>데이터 베이스 연동</b>, <b>API 호출</b>, <b>데이터 집계 및 계산</b>이 해당된다.   

## 처리 시간 줄이기 - 데이터 베이스
보통 세 가지 방법을 사용한다. <b>쿼리 튜닝(기본)</b>, <b>캐시</b>, <b>좋은 장비 사용</b>이다. 좋은 장비를 사용하는 것은 Primary/Replica 읽기 전용 데이터 베이스, 하드웨어 업그레이드를 할 수 있다.   

```
서버 ----- 데이터 베이스
 |
캐시 서버

서버 - 데이터 베이스 쓰기
     - 데이터 베이스 읽기

서버 - 데이터 베이스
            |
서버 - 데이터 베이스
```

## 처리 시간 줄이기 - API 호출
API 호출 응답 시간이 증가하면 처리 시간 또한 증가한다. API 호출 성능 개선 방법은 2가지 이다. <b>캐시</b>, <b>호출 제거</b>이다. 여기서 호출 제거는 ```메시징 + 비동기 연동```을 말한다.   

```
서버 - 외부 시스템
 |
캐시 서버

서버 - 메시징 - 외부 시스템
```

## 처리 시간 줄이기 - 데이터 집계 및 계산
미치 계산해서 캐시나 데이터 베이스에 보관하는 방법을 사용하는 것이다. 주로 통계류에 사용하는데 예를 들어 좋아요 수를 말한다.   

```
서버 - 데이터 베이스
 |
캐시 서버
```

## 응답 시간을 중이려면
대기 시간(Latency Time)을 줄여야 할 필요가 있다. 왜냐하면 응답 시간은 <b>대기 시간 + 처리 시간</b>을 말하는 것이기 때문이다.

## 대기 시간 줄이기 - 대역폭
대역폭이 작으면 클라이언트 개수가 증가할 때, 주고 받는 속도가 급격히 느려진다. 예를 들어 고속도로에 차가 증가하면 속도가 느려지는 것과 같다.   

고려할 때, 세가지 방식을 고려해야 한다.   
* 응답 크기 줄이기: 응답 압축, 이미지 파일 크기 줄이기
* 트래픽 분리하기: 이미지, 정적 파일을 CDN을 통해 제공하기
* 대역폭 늘리기: 비용 측면에서 CDN이 유리   

```
클라이언트(브라우저) - 서버
        |
       CDN
```

## 총 정리
```
                        TPS(Transaction Per Second)
                        초당 몇 개 클라이언트 요청 처리
클라이언트(브라우저)                서버                        데이터 베이스
            <-대기시간(Latency Time)-><-처리시간(Processing Time)->
            <---------------응답시간(Response Time)-------------->
```

* 대기 시간 줄이기
    * 응답 크기 줄이기
    * 정적 파일 트래픽 분리하기(CDN)
    * 대역폭 늘리기
* 처리량 높이기
    * 처리 시간 줄이기
    * 장비 추가하기(스케일아웃)
    * 쓰레드풀/커넥션풀 크기 조절하기 [커넥션풀 설정](https://www.youtube.com/watch?v=6Q7iRTb4tQE&t=0s)
* 처리 시간 줄이기
    * 데이터 베이스 쿼리 튜닝, 좋은 장비 사용하기(스케일아웃, 스케일업)
    * 캐시 사용하기
    * 데이터 미리 집계하기   

[초식 - 서버 성능 올리기](https://www.youtube.com/watch?v=JJJ4LReZ5q4)