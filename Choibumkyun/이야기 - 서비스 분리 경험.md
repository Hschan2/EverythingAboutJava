# 이야기: 서비스 분리 경험 (기능 개선, 서비스 분리 후 DB 분리)

## 상황
서비스 개편을 진행하는 것이 예정되어 있었다. 기존 기능 중 일부를 개선하는 개편을 진행하게 되었다. 기존에는 많은 기능이 한 코드와 데이터 베이스에 섞여 있는 구조였다.   

```
관리용 --> 단일 데이터 베이스 <-- 고객용
```

## 개발 방향
<b>1. 서비스 분리</b>   
기존 코드를 수정하지 않는 방향으로 진행하였다. 새 코드를 만들고 별도의 서비스로 배포하여 진행하였다.   

<b>2. 클라이언트</b>   
분리한 서비스가 제공하는 API를 사용하여 개발을 진행하였다.   

<b>3. 데이터 베이스는 그대로 유지</b>   
데이터 베이스는 그대로 유지하되 새로운 서비스는 관련 테이블만 접근하도록 진행하엿다. 기존 코드는 관련 테이블에 접근하지 않도록 설계하였다. 그리고 분리한 서비스의 API를 사용해서 접근할 수 있도록 변경하였다.   

## 구현 내용
```
                                          클라이언트
                                              |
관리용   --->       서비스       <---      고객용 HTTPD
    |                  |                      |
    |                  |                  고객용 WAS
    |                  |                      |
    |  ---> 데이터 베이스, 관련 테이블    <---  |

서비스는 하단 데이터 베이스, 관련 테이블을 향한다.
클라이언트는 고객용 HTTPD를 향하고 고객용 HTTPD는 고객용 WAS를 향한다.
```

* 관리용에 조인을 제거하고 API호출로 변경하였다.
* 서비스는 최신 버전 FW와 다른 언어, 별도 배포 처리 등의 기술을 사용하였다.
* 클라이언트는 새로운 API를 사용하였다.
* 고객용 HTTPD는 새로운 API 요청의 프록시 처리를 담당하도록 하였다.
* 고객용 WAS는 기존 코드의 삭제(주석 처리)를 처리하도록 하였다.   

클라이언트 부분에서 Apache의 수정이 있었다. Apache는 클라이언트가 새로운 API를 요청하면 프록시로 새롭게 만든 서비스로 전달한다.   

## 구현 결과
서비스 자체를 구현하는 것은 가장 쉬운 부분이었다. 새로운 코드와 원하고 익숙한 기술을 적용하면 되는 것이기 때문이다. 그리고 배포 또한 어렵지 않았다. 기존 관리용과 고객용 상관없이 서비스를 배포할 수 있기 때문이다.   

그러나 관리용 코드의 변경이 가장 어려운 부분이었다. 조인 쿼리를 분리하는 것에 많은 노력이 필요하였다. 또한, 복잡도는 오히려 증가하였다. 그래서 오류를 추적하는 것에 어려운 부분이 존재했다.   

## 데이터 베이스 분리
```
                    관련 테이블
                        |           클라이언트
                        |               |
관리용   ------>      서비스  <---   고객용 HTTPD
   |                                    |
   |                                고객용 WAS
   |                                    |
   |---->   데이터 베이스, 관련 테이블 <--|

서비스는 상단의 관련 테이블을 향한다.
```

* 데이터 베이스, 관련 테이블에서 테이블은 바로 삭제하지 않고 이름만 변경하고 에러를 추적하도록 하였다.   

이 단계를 나아가기 전에 미처 발견하지 못한 조인 혹은 테이블을 발견하여 제거할 수 있었다. 서비스가 새로 만든 테이블을 사용하도록 연결하였다.

## 데이터 베이스 분리는 쉬운 부분
특정 기간 동안 데이터 베이스 이관을 진행하였다. 점검 일자를 잡고 기존 데이터를 그대로 새로운 데이터 베이스로 이관하였다. 데이터 파일 그대로 복사하여 이동시켰다.   

코드는 데이터 베이스과 테이블의 이름을 미리 상수로 분리해 놓았으며 데이터 베이스 이관 후에 상수 변경과 JDBC URL을 변경하여 서비스를 배포하였다.   

## 정리
마이크로서비스 관련 서적에서 나와있는 방법을 사용해서 개발을 진행하였다. 결과적으로 유지보수성이 좋아졌고 새로 만든 서비스보다 기존 코드를 수정하는 것이 더 어려운 부분이었다. 특히, 쿼리에 들어 있는 조인을 해체하는 것이 어려운 부분이었다.   

위의 이야기는 개발자 최범균의 서비스 분리 경험이다. 위의 경험을 공유하여 서비스를 분리할 때 참고하면 좋을 것이다.   

[서비스 분리 경험](https://www.youtube.com/watch?v=PQQJqqPXo6s)