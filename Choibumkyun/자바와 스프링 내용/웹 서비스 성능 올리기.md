# 웹 서비스 성능 올리기 - 외부 연동 비동기

## 외부 연동과 성능
클라이언트가 서버에 요청하면 서버는 데이터 베이스와 연동을 할 것이고 외부 서비스가 제공하는 API 등을 호출하는 경우가 있다. 그리고 응답을 받고 처리를 하고 클라이언트에 데이터를 전달한다.   

그러나 우리의 서버에서 네트워크가 느려지거나 외부 서비스의 처리 시간이 길어지면 서버의 전체 실행 시간에 영향을 주게 된다. 즉, 느려진다.   

## 외부 서비스의 응답 시간과 성능 저하
예를 들어, 서버 쓰레드풀이 5개고 평균 응답 시간이 0.2초일 때.   

응답 시간에서 외부 연동이 차지하는 시간이 0.1초이다. 1개 쓰레드가 초당 5개 요청 처리를 하고 5개 쓰레드가 초당 25개 요청 처리를 한다. 이는 25TPS를 제공할 수 있다..   

그리고 외부 연동이 0.1초에서 0.9초로 증가하면 응답 시간이 1초로 증가한다. 1개 쓰레드가 초당 1개 요청 처리를 하고 5개 쓰레드가 초당 5개 요청 처리를 한다. 이는 5TPS를 제공할 수 있다. 이는 성능이 떨어지게 된다. 외부 서비스 연동하는 시간이 증가하면 전체 성능에 큰 영향을 준다는 의미가 된다.   

## 줄 서는 상황 발생
외부 서비스 성능 저하에서 25개 클라이언트가 요청을 하면 1초만에 응답을 받았던 클라이언트가 5초만에 응답을 받는 문제가 발생한다.   

## 외부 연동을 즉시 해야 하는가?
예를 들어, 로그인을 하면 포인트를 적립할 때 로그인 로직에서 외부 포인트 적립 서비스릃 호출하는데 로그인에 성공한 뒤에 수 초 이내 포인트 적립 서비스를 호출한다.   

또는, 주문을 취소하면 푸시를 발송할 때 주문 취소 로직에서 외부 푸시 발송 API를 호출하는데 주문 취소 후, 수십 초 이내 외부 푸시 발송 API를 호출한다.   

## 외부 연동에 비동기 고려
별도의 쓰레드와 프로세스로외부 연동을 처리할 수 있다. 클라이언트에서 서버에 요청을 하면 데이터 베이스 조작을 하고 외부 연동을 비동기로 처리하는 것이다. 외부 연동이 끝나지 않아도 응답할 수 있다. 외부 요청이 끝나면 그에 대한 응답이 될 것이다. 이럴 경우, 응답 시간이 줄어들 것이다.   

## 외부 연동을 비동기로 처리하면
외부 서비스에 성능 문제가 발생해도 영향이 작다. 즉, 외부 서비스 상태에 상관 없이 응답 시간과 TPS를 일정 수준 유지가 가능하다.   

## 비동기 처리 방식 세 가지
* 별도의 쓰레드
* 연동 데이터를 데이터 베이스에 저장하고 다른 쓰레드와 프로세스로 처리
* 연동 데이터를 메시징 시스템에 저장하고 다른 쓰레드와 프로세스로 처리

### 별도의 쓰레드로 실행
외부 연동 코드를 별도 쓰레드로 실행한다. 최근에는 구현이 쉬워졌다.   

```
dao.insert(data);
pushService.pushAsync(pushData);
```
```
@Async
public void pushAsync(PushData pushData) {
    pushClient.sendPush(...);
}
```

그리고 보통은 거의 즉시 실행이 된다. 그러나 고민해야 할 부분이 있다. 트랜잭션 치라 방법과 서버 재사작을 할 경우 작업 유실에 대해 생각을 해야 한다. 그리고 외부 연동 실패를 할 때 재처리 방식을 생각해야 하며 쓰레드 풀 크기도 고민해야 한다.   

재처리 필요성이 낮은 외부 연동에는 적합한 방법이다. 예를 들어, 푸시 발송, 메일 발송 등이 있다.   

### 데이터 베이스 사용
연동 데이터를 데이터 베이스에 저장을 한다. 별도 (연동 모듈이) 쓰레드와 프로세스가 연동 처리를 한다. 이런 경우, 데이터 베이스에서 연동 데이터를 조회하고 나서 외부 연동을 처리한다.   

이 방법은 데이터 베이스 트랜잭션 처리가 쉽다. 데이터 베이스에 접근 시도를 했다 롤백이 되면 같이 롤백이 되고 커밋이 되면 같이 커밋이 된다. 그리고 외부 연동 실패 시 재처리가 쉽다. 이 방법은 누락이 없어야 할 연동에 적합하다. 예를 들어, 로그인 포인트 적립 등에 사용할 수 있다.   

### 메시징 시스템 사용
연동 데이터를 메시징 시스템에 저장한다. 예를 들어서 카프카 같은 곳에 저장한다. 그리고 (연동 모듈이) 별도 쓰레드와 프로세스가 연동 처리를 한다. 이는 메시징 시스템에서 데이터를 수신해서 외부 연동 처리를 한다.   

이 방법은 대량 데이터 처리에 이점이 있으며 외부 연동 실패 시 재처리에 용이하다. 그러나 데이터를 유실할 수 있는 가능성을 고려해야 한다. 외부 연동 과정에서 실패했을 때 데이터가 소실되는 가능성이 존재할 수 있다.   

## 정리
외부 연동을 동기 처리로 할 필요는 없다. 경우에 따라 비동기 처리(Async)로 할 수 있다. 이를 통해 외부 서비스로 인한 성능 저하를 줄일 수 있지만 복잡도가 증가하다. 만약 외부 연동이 성능에 영향을 준다면 비동기 연동을 고려하는 것이 좋다.   

그리고 재처리와 트랜잭션 등 제약이 별로 없다면 별도 쓰레드로 비동기 처리를 하는 것이 좋다.   

그리고 연동과 성능에 대한 요구가 높다면 데이터 베이스 + 메시징 조합까지 고려하는 것이 좋다.   

[웹 서비스 성능 올리기](https://www.youtube.com/watch?v=FCNNcl48k28)