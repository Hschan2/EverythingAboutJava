# 커넥션풀 설정

## 데이터 베이스 커넥션 풀 (DB Connection Pool)
예를 들어서 확인한다.
```
풀이 관리하는 커넥션
    커넥션(사용 중인 (In Use) 커넥션) <-쿼리 실행- 코드
    커넥션 <-- 코드
    커넥션 - 풀
    커넥션 - 풀
    커넥션(유후 (Idle) 커넥션) - 풀
```

## DB 커넥션 풀을 왜 사용할까?
* DB와 네트워크 연결하는 시간을 단축한다.
    * 응답 시간 단축
    * 처리량 증가
* DB에 대한 커넥션 개수를 일정 수준으로 제한
    * DB 포화 방지
    * 일관된 DB 성능 유지   

그러나 DB 커넥션 풀을 잘못 설정한다면 성능 상 문제가 발생할 수 있다.   
* 올바르게 설정하지 않으면 성능 문제 유발
* 설정이 성능에 주는 영향을 파악 필수
* 스프링 부트의 기본 풀인 Hikari 기준으로 설정   

## DB 커넥션 풀 설정

### 첫 번째: 최대 개수 설정
* 최대 개수 설정: Maximum Pool Size 설정
    * 최대 커넥션 개수
        * 풀이 제공할 수 있는 최대 커넥션 개수
        * 사용 중 + 유휴(Idle) 커넥션
        * 설정에 따라 낼 수 있는 TPS가 달라짐
    * 계산에 필요한 항목
        * 한 커넥션 당 쿼리 실행 시간, 최대(목표)TPS
    * 단순 계산식
        * 최대 TPS = 1개 커넥션의 초당 처리 요청 개수 * 동시 커넥션 개수
        * 동시 커넥션 개수 = 최대 TPS / 1개 커넥션의 초당 요청 처리 개수
        * 동시 커넥션 개수 = 최대 TPS / (1초 / 쿼리 실행 시간)   

예시.
```
* 조건
    * 한 웹 요청이 한 개의 커넥션을 사용한다고 가정한다.
    * 한 웹 요청이 실행하는 쿼리 총 실행 시간이 0.1초이다.
    * 목표 TPS는 100이다.
* 동시에 필요한 커넥션 개수를 단순하게 계산하면
    *동시 커넥션 개수 = 목표 TPS / (1초 / 쿼리 실행 시간)
                    = 100 / (1초 / 0.1초) = 10
    * 즉, 커넥션풀 최대 개수가 10이고 한 요청에 평균 0.1초 소요되면 100 TPS를 처리할 수 있다.
```

최대 개수를 고려해야 할 사항에는   

```
* 평균 이상으로 실행 시간이 튀는 개수나 비율을 검토한다.
    * 0.1가 평균인데 1초 걸리는 쿼리가 순간적으로 5개가 발생한다면
    * 커넥션풀 최대 개수 10개일 때, TPS가 100 -> 55개로 떨어진다.
        * 1초 / 1초 * 5개 요청: 5 TPS
        * 1초 / 0.1초 * 5: 50 TPS
* 느린 쿼리를 염두하고 최대 개수를 높여야 한다.
```

### 두 번째: 커넥션 대기 시간 설정
* 커넥션 대기 시간: ConnectionTimeout
* 풀에서 커넥션을 구하기 위해 대기하는 시간
    * 풀의 모든 커넥션이 사용줄일 때, 대기 발생
* 고려 사항
    * 기본 값은 너무 큰: 무려 30초
        * 순간적인 트래픽 증가 시 쓰레드풀 WAS는 모든 쓰레드가 대기할 수 있음
        * 사용자는 응답없는 상태 지속
    * 기본 값 대신에 0.5 ~ 3초 이내로 설정
        * 응답없는 것보다 빠르게 에러 화면을 응답하는 것이 효율   

### 세 번째: 커넥션 최대 유지 시간 설정
* 커넥션 최대 유지 시간: maxLifeTime
* 커넥션의 최대 유지 시간
    * 커넥션을 생성한 이 후 이 시간이 지나면 커넥션을 닫고 풀에서 제거
    * 제거한 뒤 커넥션 새로 생성
* 기본 규칙
    * 네트워크나 DB의 관련 설정 값보다 작은 값 사용
        * 관련 설정 예시: 네트워크 장비의 최대 TCP 커넥션 유지 시간
* 해당 값이 관련 설정보다 크다면
    * 이미 유효하지 않은 커넥션이 풀에 남음
    * 풀에서 유효하지 않은 커넥션을 구하는 과정에서 커넥션을 새로 생성
    * 트래픽이 몰리는 시점인 경우 성능 저하 유발   

### 네 번째: 커넥션 확인 주기 설정
* 커넥션 확인 주기: keepAliveTime
* 커넥션이 살아 있는지 확인하는 주기
    * 유휴(Idle) 커넥션에 대해 커넥션 확인ㅇ
    * 유효하지 않은 커넥션은 풀에서 제거
    * 제거한 뒤에 커넥션 새로 생성
* 기본 규칙
    * 네트워크나 DB의 관련 설정 값보다 작은 값 사용
        * 관련 설정 예시: DB의 미활동 커넥션 대기 시간   

### 다섯 번째: 최소 유휴 커넥션
* 최소 유휴 커넥션: minimumIdle
* 풀에 유지할 최소 유휴 커넥션 개수
    * 설정항지 않으면 maximumPoolSize와 동일
* 기본 규칙
    * Hikari 문서: 설정하지 않는 것을 추천
        * 즉, maximumPoolSize과 동일 크기를 추천 (고정 크기 풀 추천)
        * 이 값이 작으면 급격한 트래픽 증가 시 성능 저하 유발 가능성
    * 설정할 경우 다음을 고려
        * 트래픽이 서서히 증가 -> 최소 시점 TPS 기준
        * 트래픽이 특정 시점에 급격히 증가 -> 설정하지 않을 것
* 트래픽 적은 시간대 DB 자원 사용 줄이기 위해 설정   

### 여섯 번째: 최대 유휴 시간 설정
* 최대 유휴 시간: idleTimeOut
* 사용되지 않고 풀에 머무를 수 있는 시간
    * 풀에서 이 시간동안 머무른 커넥션은 종료하고 풀에서 제거
    * minimumIdle < maximumPoolSize 인 경우에 적용
    * 이 시간이 지났다고 바로 빨라지지 않음 (문서: 15초 +)
* 기본 규칙
    * 트래픽이 빠지는 시간 간격   

## 정리
* maximumPoolSize: 최대 TPS 고려하여 설정
* connectionTimeOut: 일반적인 서비스에서는 길면 안 됨
    * 응답없는 화면 발생
* maxLifeTime: 일정 시간만 사용하고 커넥션 종료 처리할 수 있게 처리
    * 보통 DB 연결은 무한하지 않음
* keepAliveTime: 끊길 만한 시간보다 짧은 주기로 검사할 수 있게 지정   

[커넥션풀 설정](https://www.youtube.com/watch?v=6Q7iRTb4tQE)