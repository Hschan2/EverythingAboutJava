# 웹 스토리지와 쿠키

## 쿠키
* 정의: 브라우저에 저장되는 작은 크기의 문자열 (최대 4kb), 매직 쿠키에 영감을 얻어서 사용
    * 매직 쿠키: 프로그램이 수신한 뒤 변경하지 않고 보내는 데이터 패킷   

### 쿠키 특징
* 주로 서버에서 사용
    * (Set-Cookie: <cookie-name>=</cookie-value>)
* 요청 시 Headers에 전송
    * 같은 도메인에서 만들어진 쿠키만 전송
    * (사용자 --cookie.kr에서 생성된 쿠키--> https://cookie.kr)
* 만료 기간 지정 가능
    * (Set-Cookie: <cookie-name>=</cookie-value>; Expires=<date>)
    * (Set-Cookie: <cookie-name>=</cookie-value>; Max-Age=<number>)   

### 쿠키 종류
* 영구 쿠키(Persistent Cookie)
    * 만료 기간 존재
    * 만료 기간이 끝난 후 삭제
* 세션 쿠키 (Session Cookie)
    * 만료 기간 미존재
    * 브라우저 종료 시 삭제   

* 퍼스트파티 쿠키 (First Party Cookie)
    * 같은 도메인에 생성된 쿠키
    * 같은 도메인 (예. cookie.kr)
    * 서브 도메인 (예. m.cookie.kr)
* 서드파티 쿠키 (Third Party Cookie)
    * 다른 도메인에 생성된 쿠키
    * 다른 도메인 (예. anotherCookie.com
    * 사용자의 방문 사이트 파악 (광고) 목적   

### 쿠키 문제점
* CSRF: 사용자의 권한을 이용한 공격 (비밀번호 변경, 결제 요청 등)
    * CSRF 특징: 쿠키가 자동으로 전송 - 이를 이용한 공격
* XSS: 사용자의 민감한 정보 탈취 (토큰) - 악성 스크립트 사용
    * Reflected XSS
    * Stored XSS
    * DOM-based XSS
* 부족한 저장 용량: 4KB
* HTTP 요청 시 자동으로 모든 쿠키 전송: 불필요한 트래픽 증가   

## 웹 스토리지
쿠키가 가지고 있는 문제점들을 해결할 수 있도록 개발. 동기적으로 실행.   

### 웹 스토리지 특징
* 5MB의 저장 용량: 쿠키의 부족한 저장 용량 문제 해결
* 요청 시 Headers에 전송하지 않음: 쿠키의 CSRF, 트래픽 문제 해결
* 문자열만 저장 가능: 직렬화를 통해 객체 저장 가능   
   
||로컬 스토리지|세션 스토리지(추천)|
|:---:|:---:|:---:|
|저장 범위|도메인 / 브라우저|도메인 /브라우저 / 탭|
|삭제 시기|직접 삭제 시|탭 종료 시|

### 웹 스토리지 사용 시 고려할 점
* 직렬화를 사용해 객체를 저장하기 때문에 객체를 사용하기 위해서 역직렬화 과정이 필요하다. 즉 직렬화, 역직렬화 과정이 필요하다.   
    * 직렬화할 때 순환 참조이거나 역직렬화할 때 JSON 형식이 아닌 경우 에러 발생
* 브라우저 미지원
    * 웹 스토리지 비활성화 설정 (사파리 시크릿 모드에서 웹 스토리지 사용 시 에러 (할당랼이 0으로 제한)) = 에러 처리 필수

### 웹 스토리지 문제점
* XSS: 자바스크립트로 접근 가능
* 독립된 스토리지: 브라우저 / 탭 (세션 스토리지) 간 공유 불가
* 만료 기간 설정 불가
* 동기적으로 실행
    * 메인 스레드 블로킹 - 큰 데이터 사용 주의
    * 용량이 크다면 IndexedDB 고려   

## 쿠키 & 로컬 / 세션 스토리지 사용처
* 쿠키 & 웹 스토리지
    * 보안 문제가 있기 때문에 민감한 정보는 저장하지 않는다.
* 쿠키 (기간 설정, 작은 용량의 서버 전송)
    * N일 동안 보지 않기
    * 비로그인 장바구니
* 세션 스토리지 (탭 종료 시 삭제되어도 가능)
    * 이전 페이지 저장
    * 이전 스크롤 위치 저장
* 로컬 스토리지 (브라우저 종료 시 유지)
    * 사용자 설정 저장
    * 글 임시 저장

## 쿠키 보안 문제 해결 방안
||해결 방안|이유|
|:---:|:---:|:---:|
|XSS|HttpOnly|자바스크립트로 접근 불가|
|CSRF|SameSite|같은 도메인의 요청에만 쿠키를 전송|
||Referer 검증|요청이 온 사이트의 도메인 확인 가능|

SameSite에서 설정해야 할 옵션이 있다.   
* Strict: 모두 허용하지 않음
* Lax: 안전한 GET 요청만 허용 (A 태그)   

크롬 브라우저는 기본적으로 Lax 옵션이 설정되어 있기 때문에 CSRF에 대한 약간의 대처가 존재해 있다.   

## 웹 스토리지 보안 문제 해결 방안
||해결 방안|이유|
|:---:|:---:|:---:|
|CSS|innerHTML 사용 X|자바스크립트 코드 삽입 불가|

innerHTML 사용하지 않는 이유는 사용자의 입력이 자바스크립트 코드로 실행될 수 있는 코드를 작성하지 않는 것을 말한다. 예로 들어서 ```innerHTML, eval, document.write```가 있다.   

만약에 innerHTML를 사용이 필요하다면 XSS 보안 라이브러리 (sanitize-html, DOMPurify)를 사용하는 것이 좋다.   

[Web Storage and Cookie](https://www.youtube.com/watch?v=-4ZsGy1LOiE)