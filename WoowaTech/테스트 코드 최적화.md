# 테스트 코드 최적화

## 무거운 테스트 코드
코드가 길어지고 테스트가 필요한 코드가 많아질수록 테스트 코드 또한 무거워졌다. 그래서 테스트 코드를 동작하는 데 오랜 시간이 걸리면서 빠르게 확인이 불가능하고 리팩토링이 어려운 등 많은 문제가 발생한다.   

무거운 테스트 코드로 인해 발생하는 문제를 해결하기 위한 방법은 무엇일까?

## @DirtiesContext 제거하기
테스트 코드의 속도를 가장 효과적으로 줄일 수 있는 방법이다. 이는 테스트를 할 때마다 새로운 애플리케이션을 로드한다.   

스프링에서는 애플리케이션 컨텍스트를 캐싱하는 기능을 기본적으로 제공한다. 그래서 테스트를 할 때마다 애플리케이션 컨텍스트를 로드할 필요 없이 한 번만 로드하고 사용하는 테스트가 가능하다.   

만약 @DirtiesContext를 사용한다면 위와 같은 장점을 사용하지 않겠다는 것을 말한다. @DirtiesContext는 사용 타당성이 충분할 경우에만 사용하는 것이 좋다.   

그러나 @DirtiesContext를 제거했다고 해서 모두 해결되는 것은 아니다. 여전히 컨텍스트가 재생성이 되는 경우가 발생한다.   

## Application Context 조건 파악하기

이유는 스프링이 애플리케이션 컨텍스트를 캐싱하는 기준에 있다. 즉, 애플리케이션 컨텍스트의 캐싱 조건을 파악하는 것이 중요하다.   

애플리케이션 컨텍스트 설정이 다른 테스트를 실행을 하면 스프링은 기존 컨텍스트를 재활용하지 않고 새로운 컨텍스트를 생성한다.   

그래서 애플리케이션 컨텍스트를 공유하는 방법을 생각하고 활용하는 것이 좋다. 이는 테스트 속도의 이점을 얻을 수 있다.   

```
자세한 예시의 내용은 영상의 Application Context 캐싱 조건 파악하기 부분을 확인하자!!!
```

## 테스트용 FIxture 환경 재사용하기
더욱 빠른 테스트 코드의 속도를 가질 수 있다. 전체 테스트 중 가장 많은 시간을 차지하는 테스트는 인수 테스트이다. 이는 실제 서버를 구동하고 HTTP 요청을 보내고 테스트를 진행한다. 그래서 더욱 무겁고 네트워크 지연이 발생하여 더 많은 시간을 소비하게 된다.   

대부분 WebTest 클라이언트를 사용한 비동기 테스트를 진행하거나 WebMvcTest와 같이 모킹을 이용한 테스트로 대체하여 테스트 시간을 줄이고 있다.   

그러나 이를 사용하지 않고 테스트 시간을 줄이는 방법을 찾는다.   

테스트 코드는 데이터 삽입 -> 테스트 수행 -> 데이터 삭제 순서대로 동작한다. 여기서 테스트 시간을 크게 높이는 원인은 테스트 Fixture를 통해서 데이터 베이스 환경을 구성하는 부분이다.   

인수 테스트는 시나리오 테스트로써 Fixture 환경을 구성하기 위해서 보통 POST 요청을 보내는 방식을 이용한다. 만약 테스트 환경을 재활용한다면 테스트 시간을 줄일 수 있을 것이다. 그러나 상태를 변경하면 안 된다.   

그러나 조회 테스트는 HTTP GET 메서드를 사용하기 때문에 영향을 끼치지 않는다. GET은 서버에서 데이터에 아무런 영향을 끼치지 않는 안전한 메서드이기 때문이다.   

```
이와 관련된 내용의 예시는 영상의 테스트용 Fixture 환경을 재사용하기 부분을 참고하자!!!   
```

이러한 방법으로 영상에서의 예시로 조회 테스트와 그 외의 테스트들이 서로 다른 데이터 베이스 테스트 환경을 사용하게 되었고 조회 테스트 경우 테스트 환경을 재사용할 수 있게 되었다.   

그러나 테스트용 Fixture 환경을 재사용하는 방법은 조회 관련 테스트를 작성하는 개발자가 데이터 베이스의 상태를 알고 있어야 하며 새로운 도메인이 추가되었을 때 조회 테스트를 위한 환경을 아주 조심히 구성해야 하는 단점이 있다.   

그러나 이 방법을 사용하면 리팩토링을 진행해야 하는 <b>레거시 프로젝트</b>나 <b>작은 규모의 프로젝트</b>에서 적용되면 큰 효과를 얻을 수 있다. 빠른 테스트는 리팩토링에서 중요한 부분이기 때문이다.   

[테스트 코드 최적화](https://www.youtube.com/watch?v=N06UeRrWFdY)